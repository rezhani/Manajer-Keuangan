<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Perkembangan Aset</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            font-size: 16px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            margin: 1em auto;
            max-width: 95%;
            padding: 1.5em;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }

        h1, h2 {
            text-align: center;
            color: #2a5298;
        }

        .header {
            padding: 1em;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0 0 20px 20px;
            color: #fff;
        }

        .header h1 {
            font-size: 2em;
            background: linear-gradient(to right, #fff, #e0f7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chart-container {
            position: relative;
            height: 40vh;
            margin: 1em 0;
        }

        canvas {
            max-width: 100%;
            height: 100%;
            display: block;
            margin: 0 auto;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1em;
            margin: 1em 0;
            flex-wrap: wrap;
        }

        input, select, button {
            padding: 0.8em;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }

        input:focus, select:focus, button:focus {
            border-color: #2a5298;
            outline: none;
        }

        button {
            background: linear-gradient(to right, #2a5298, #1e3c72);
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary {
            background: #f0f7ff;
            padding: 1em;
            border-radius: 10px;
            text-align: center;
            margin: 1em 0;
        }

        #toast {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 1em 2em;
            border-radius: 50px;
            z-index: 1000;
        }

        .dark-mode {
            background: #121212;
            color: #e0e0e0;
        }

        .dark-mode .container { background: rgba(30, 30, 40, 0.92); }
        .dark-mode h1, .dark-mode h2 { color: #8ab4f8; }
        .dark-mode input, .dark-mode select, .dark-mode button { background: #2d2d3a; color: #e0e0e0; border-color: #444; }
        .dark-mode button:hover { background: linear-gradient(to right, #2a5298, #1e3c72); }
        .dark-mode .summary { background: rgba(30, 40, 60, 0.6); }

        @media (min-width: 768px) {
            .container { max-width: 1000px; }
            .chart-container { height: 50vh; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dasbor Perkembangan Aset</h1>
        <p>Lacak perkembangan aset Anda dengan mengunggah data JSON</p>
    </div>

    <div id="toast"></div>

    <div class="container">
        <div class="controls">
            <input type="file" id="uploadJson" accept=".json">
            <button onclick="uploadJsonData()">Upload JSON</button>
            <select id="monthSelect">
                <option value="1">Januari</option>
                <option value="2">Februari</option>
                <option value="3">Maret</option>
                <option value="4">April</option>
                <option value="5">Mei</option>
                <option value="6" selected>Juni</option>
                <option value="7">Juli</option>
                <option value="8">Agustus</option>
                <option value="9">September</option>
                <option value="10">Oktober</option>
                <option value="11">November</option>
                <option value="12">Desember</option>
            </select>
            <select id="yearSelect">
                <option value="2025" selected>2025</option>
            </select>
            <button onclick="updateChart()">Perbarui Grafik</button>
            <button onclick="toggleTheme()">Toggle Tema Gelap</button>
        </div>

        <div class="summary">
            <h2>Ringkasan Aset</h2>
            <p id="totalAssets">Total Aset: Rp0</p>
        </div>

        <div class="chart-container">
            <canvas id="assetChart"></canvas>
        </div>
    </div>

    <script>
        let jsonData = {
            assets: {},
            transaksi: []
        };

        let assetChart;
        const assetChartCanvas = document.getElementById("assetChart").getContext("2d");
        const totalAssetsDiv = document.getElementById("totalAssets");
        const yearSelect = document.getElementById("yearSelect");

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        function calculateTotalAssets() {
            let total = 0;
            
            if (jsonData.assets.Investasi) {
                total += Object.values(jsonData.assets.Investasi).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            }
            
            if (jsonData.assets.Tunai) {
                total += Object.values(jsonData.assets.Tunai).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            }
            
            if (jsonData.assets["Aset Konsumtif"]) {
                total += Object.values(jsonData.assets["Aset Konsumtif"]).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            }
            
            return total;
        }

        function parseDate(dateStr) {
            const parts = dateStr.split(/[\s/]+/);
            if (parts.length < 3) return null;
            const monthNames = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];
            const month = monthNames.indexOf(parts[1].toLowerCase());
            if (month === -1) return null;
            const day = parseInt(parts[0]);
            const year = parseInt(parts[2] || parts[parts.length - 1]);
            return new Date(year, month, day);
        }

        function updateYearDropdown() {
            const years = new Set(jsonData.transaksi.map(trans => {
                const date = parseDate(trans.date);
                return date ? date.getFullYear() : null;
            }).filter(year => year));
            
            yearSelect.innerHTML = '';
            
            if (years.size === 0) {
                const option = document.createElement('option');
                option.value = 2025;
                option.textContent = 2025;
                option.selected = true;
                yearSelect.appendChild(option);
            } else {
                Array.from(years).sort().forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === 2025) option.selected = true;
                    yearSelect.appendChild(option);
                });
            }
        }

        function getDateRange(month, year) {
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            return { startDate, endDate };
        }

        function getDailyAssets(month, year) {
            const { startDate, endDate } = getDateRange(month, year);
            const daysInMonth = endDate.getDate();
            const dailyAssets = new Array(daysInMonth).fill(null);
            
            const transaksiBulanIni = jsonData.transaksi
                .map(trans => ({ ...trans, parsedDate: parseDate(trans.date) }))
                .filter(trans => trans.parsedDate && trans.parsedDate >= startDate && trans.parsedDate <= endDate)
                .sort((a, b) => a.parsedDate - b.parsedDate);

            if (transaksiBulanIni.length === 0) {
                return { dailyAssets: [], labels: [], hasData: false };
            }

            // Hitung saldo awal
            let saldoAwal = calculateTotalAssets();
            
            // Koreksi saldo awal dengan transaksi sebelum bulan ini
            jsonData.transaksi.forEach(trans => {
                const transDate = parseDate(trans.date);
                if (!transDate || transDate >= startDate) return;
                
                // Skip transfer antar rekening
                if (trans.title.includes("Tf ") || trans.title.includes("Transfer ")) return;
                
                if (trans.categoryType === "Tunai") {
                    saldoAwal += trans.amount;
                }
            });

            // Proses transaksi bulan ini
            let currentBalance = saldoAwal;
            const datesWithData = new Set();
            
            transaksiBulanIni.forEach(trans => {
                const day = trans.parsedDate.getDate();
                datesWithData.add(day);
                
                // Skip transfer antar rekening
                if (trans.title.includes("Tf ") || trans.title.includes("Transfer ")) return;
                
                if (trans.categoryType === "Tunai") {
                    currentBalance += trans.amount;
                    dailyAssets[day - 1] = currentBalance;
                }
            });

            // Buat array hanya untuk tanggal yang ada datanya
            const sortedDates = Array.from(datesWithData).sort((a, b) => a - b);
            const filteredAssets = sortedDates.map(day => dailyAssets[day - 1]);
            const labels = sortedDates.map(day => day.toString());

            return { 
                dailyAssets: filteredAssets, 
                labels,
                hasData: true 
            };
        }

        function createAssetChart(month, year) {
            const { dailyAssets, labels, hasData } = getDailyAssets(month, year);
            
            if (assetChart) assetChart.destroy();
            
            if (!hasData || dailyAssets.length === 0) {
                assetChart = new Chart(assetChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Total Aset (Rp)',
                            data: [],
                            backgroundColor: 'rgba(42, 82, 152, 0.6)',
                            borderColor: 'rgba(42, 82, 152, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Total Aset (Rp)' },
                                ticks: { callback: value => 'Rp' + value.toLocaleString('id-ID') }
                            },
                            x: { title: { display: true, text: 'Tanggal' } }
                        },
                        plugins: {
                            title: { 
                                display: true, 
                                text: `Tidak ada data transaksi untuk ${new Date(year, month - 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' })}`, 
                                font: { size: 18 } 
                            },
                            legend: { position: 'top' },
                            datalabels: { display: false }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
                
                totalAssetsDiv.textContent = `Total Aset: Rp${calculateTotalAssets().toLocaleString('id-ID')}`;
                return;
            }

            assetChart = new Chart(assetChartCanvas, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Aset (Rp)',
                        data: dailyAssets,
                        backgroundColor: 'rgba(42, 82, 152, 0.2)',
                        borderColor: 'rgba(42, 82, 152, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(42, 82, 152, 1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Total Aset (Rp)' },
                            ticks: { callback: value => 'Rp' + value.toLocaleString('id-ID') }
                        },
                        x: { title: { display: true, text: 'Tanggal' } }
                    },
                    plugins: {
                        title: { 
                            display: true, 
                            text: `Perkembangan Aset - ${new Date(year, month - 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' })}`, 
                            font: { size: 18 } 
                        },
                        legend: { position: 'top' },
                        datalabels: { display: false }
                    }
                },
                plugins: [ChartDataLabels]
            });

            const totalAkhir = dailyAssets.length > 0 ? dailyAssets[dailyAssets.length - 1] : calculateTotalAssets();
            totalAssetsDiv.textContent = `Total Aset: Rp${totalAkhir.toLocaleString('id-ID')}`;
        }

        function uploadJsonData() {
            const fileInput = document.getElementById('uploadJson');
            const file = fileInput.files[0];
            if (!file) return showToast('Pilih file JSON terlebih dahulu');

            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const uploadedData = JSON.parse(e.target.result);
                    if (!uploadedData.assets || !uploadedData.transaksi) {
                        throw new Error('Format JSON tidak valid: harus mengandung "assets" dan "transaksi"');
                    }
                    jsonData = uploadedData;
                    updateYearDropdown();
                    updateChart();
                    showToast('Data JSON berhasil diunggah');
                } catch (error) {
                    showToast('Error: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function updateChart() {
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            createAssetChart(month, year);
        }

        // Inisialisasi
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        updateYearDropdown();
        createAssetChart(6, 2025); // Default: Juni 2025
    </script>
</body>
</html>
